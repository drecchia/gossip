"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,r)}return o}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(o),!0).forEach(function(t){_defineProperty(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,o){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var r=o.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var Gossip=function(){return _createClass(function e(){_classCallCheck(this,e)},null,[{key:"safeGetItem",value:function(e){try{return localStorage.getItem(e)}catch(t){return console.error('Failed to get item from localStorage with key "'.concat(e,'":'),t),null}}},{key:"safeSetItem",value:function(e,t){try{localStorage.setItem(e,t)}catch(t){console.error('Failed to set item in localStorage with key "'.concat(e,'":'),t)}}},{key:"safeRemoveItem",value:function(e){try{localStorage.removeItem(e)}catch(t){console.error('Failed to remove item from localStorage with key "'.concat(e,'":'),t)}}},{key:"whisper",value:function(e){try{var t=this.safeGetItem(this.localStorageKey),o=t?JSON.parse(t):[];o.push(e),this.safeSetItem(this.localStorageKey,JSON.stringify(o))}catch(e){return console.error("Failed to whisper gossip data:",e),!1}return!0}},{key:"autoPublish",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"POST",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3e4,n=0,i=0;setInterval(function(){var a=t.safeGetItem(t.localStorageKey),l=a?JSON.parse(a).length:0;n>=5&&l===i?console.log("Max failures reached and no new data. Skipping publish attempt."):(l!==i&&(n=0,i=l),t.publish(e,o,r)?(n=0,i=0):(n++,console.error("Publish attempt failed. Total failed attempts: ".concat(n))))},a)}},{key:"publish",value:function(e){var t,o=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"POST",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if((t=o.safeGetItem(o.localStorageLockKey))&&Date.now()-parseInt(t,10)<3e4)return console.log("Delivery is locked, skipping..."),!1;var n,i,l,c=this.safeGetItem(this.localStorageKey);if(!c)return!0;o.safeSetItem(o.localStorageLockKey,Date.now().toString()),n=this.localStorageKey,i=this.localStorageTmpKey,(l=o.safeGetItem(n))&&(o.safeSetItem(i,l),o.safeRemoveItem(n)),fetch(e,{method:r,headers:_objectSpread({"Content-Type":"application/json"},a),body:c}).then(function(e){if(!e.ok)throw new Error("Failed to publish data: ".concat(e.status," - ").concat(e.statusText));return o.safeRemoveItem(o.localStorageTmpKey),!0}).catch(function(e){console.error("Publish error:",e);var t=o.safeGetItem(o.localStorageKey),r=JSON.parse(c),a=t?JSON.parse(t).concat(r):r;return o.safeSetItem(o.localStorageKey,JSON.stringify(a)),o.safeRemoveItem(o.localStorageTmpKey),!1}).finally(function(){o.safeRemoveItem(o.localStorageLockKey)})}}])}();_defineProperty(Gossip,"localStorageKey","gossipQueue"),_defineProperty(Gossip,"localStorageTmpKey","gossipTmpQueue"),_defineProperty(Gossip,"localStorageLockKey","gossipLockedSince");